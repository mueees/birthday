var T = require("./twitterSteram").T, // twitter constructor
    _ = require("underscore"),
    socketServer = require("socketServer/worker");

var opts = {
    whiteListParametres: ["track", "language", "people"],
    defaultStream: {
        track: ['javascript', 'usa', 'fun']
    }
}

function Twitter(){
    this.twitterStream = null;
    this.streamState = false;
    _.bindAll(this, "addListener", "getNewTweet", "changeChannel");
    this.init();
}

Twitter.prototype = {

    init: function(){
        this.createStream(opts.defaultStream);
    },

    addListener: function(req, res, next){
        socketServer.addStreamToClientChannel("twitter:newTweet", res.idStream);
        res.send();
    },

    createStream: function(data){
        var _this = this;
        this.stopStream();

        var options = this.createOptionsForStream(data);

        this.twitterStream = T.stream('statuses/filter', options);
        this.twitterStream.on('tweet', function(tweet){
            _this.getNewTweet(tweet);
        });

        this.streamState = true;
    },

    //todo: добавить построение options по переданным параметрам
    createOptionsForStream: function(data){
        return data;
    },

    changeChannel: function( req, res, next ){
        var data = req.getData();

        //todo добавить data.key для публичной демонстрации
        /*if( !data.key ){
            next(new Error('Key is necessary for change channel'));
        }*/

        //todo: валидация необходимых данный отправленных клиентом
        this.createStream(data);

        res.send();
    },

    stopStream: function(){
        if( !this.streamState ) return false;

        this.twitterStream.off();
        this.twitterStream.close();
        this.twitterStream = null;
        this.streamState = false;
    },

    getNewTweet: function(tweet){
        //todo: добавить фильтрацию входящих твитов
        //в канал сервера комманда toClientChannel,
        //всем stream, которые зарегестрировались в канале twitter:newTweet, для получения новых
        //твитов, выслать новый твит

        socketServer.channel.emit("toClientChannel", {
            params: tweet,
            channel: "twitter:newTweet"
        });
    }

}

module.exports = new Twitter();